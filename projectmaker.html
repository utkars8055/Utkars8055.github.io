<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Project Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="stylesheet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --secondary-color: #2ecc71;
      --secondary-dark: #27ae60;
      --bg-color: #f9f9f9;
      --text-color: #333;
      --border-color: #ddd;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      margin: 0;
      padding: 0;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1, h2, h3 {
      font-weight: 500;
      margin-top: 0;
      color: #2c3e50;
    }
    
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      border-radius: 8px;
      background-color: white;
      box-shadow: var(--shadow);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
      transition: border 0.3s ease;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }
    
    button:hover {
      background-color: var(--primary-dark);
    }
    
    button.secondary {
      background-color: var(--secondary-color);
    }
    
    button.secondary:hover {
      background-color: var(--secondary-dark);
    }
    
    .button-group {
      display: flex;
      gap: 10px;
    }
    
    .hidden {
      display: none;
    }
    
    .preview {
      margin-top: 25px;
      border: 1px solid var(--border-color);
      padding: 20px;
      border-radius: 8px;
      background-color: white;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      background-color: transparent;
      border: none;
      font-weight: 500;
      color: #7f8c8d;
      position: relative;
      transition: color 0.3s ease;
    }
    
    .tab:after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--primary-color);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .tab.active {
      color: var(--primary-color);
    }
    
    .tab.active:after {
      transform: scaleX(1);
    }
    
    .tab-content {
      display: none;
      padding: 25px;
      border-radius: 8px;
      background-color: white;
      box-shadow: var(--shadow);
    }
    
    .tab-content.active {
      display: block;
    }
    
    .output-container {
      background-color: #f5f5f5;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-top: 25px;
      overflow: auto;
      position: relative;
    }
    
    code {
      white-space: pre-wrap;
      font-family: Consolas, Monaco, 'Andale Mono', monospace;
      font-size: 14px;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      display: block;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f5f5f5;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 13px;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 4px;
      background-color: #2ecc71;
      color: white;
      z-index: 1000;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.error {
      background-color: #e74c3c;
      display: block;
    }
    
    @media screen and (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .login-container {
        margin: 50px auto;
        padding: 20px;
      }
      
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab {
        flex: 1 1 auto;
        text-align: center;
        padding: 10px;
      }
      
      .tab-content {
        padding: 15px;
      }
      
      .button-group {
        flex-direction: column;
      }
    }
    
    /* Fix for hover animation */
    .one {
      position: relative;
      overflow: hidden;
    }
    .two {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Toast notification container -->
    <div id="toast" class="toast"></div>
    
    <div id="login-section" class="login-container">
      <h2>Project Manager</h2>
      <p>Please enter your password to access the project management interface.</p>
      <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" placeholder="Enter password" required>
        <div id="password-error" class="error">Invalid password. Please try again.</div>
      </div>
      <button id="login-btn">
        <span id="login-spinner" class="spinner hidden"></span>
        <span id="login-text">Login</span>
      </button>
    </div>

    <div id="editor-section" class="hidden">
      <h1>Project Manager</h1>
      
      <div class="tabs">
        <button class="tab active" data-tab="new-project">
          <i class="fas fa-plus-circle"></i> New Project
        </button>
        <button class="tab" data-tab="edit-project">
          <i class="fas fa-edit"></i> Edit Existing Project
        </button>
        <button class="tab" data-tab="help">
          <i class="fas fa-question-circle"></i> Help
        </button>
      </div>
      
      <div id="new-project" class="tab-content active">
        <h2>Create New Project</h2>
        <form id="new-project-form">
          <div class="form-group">
            <label for="project-title">Project Title:<span style="color: #e74c3c">*</span></label>
            <input type="text" id="project-title" placeholder="Enter project title" required>
            <div id="title-error" class="error">Project title is required</div>
          </div>
          
          <div class="form-group">
            <label for="project-image">Project Image Path:<span style="color: #e74c3c">*</span></label>
            <input type="text" id="project-image" placeholder="images/project.jpg" required>
            <div id="image-error" class="error">Image path is required</div>
          </div>
          
          <div class="form-group">
            <label for="project-video">Project Video Path (optional):</label>
            <input type="text" id="project-video" placeholder="images/project.mp4">
          </div>
          
          <div class="form-group">
            <label for="authors">Authors (comma separated):<span style="color: #e74c3c">*</span></label>
            <input type="text" id="authors" placeholder="Author 1, Author 2, ..." required>
            <div id="authors-error" class="error">At least one author is required</div>
          </div>
          
          <div class="form-group">
            <label for="publication">Publication:<span style="color: #e74c3c">*</span></label>
            <input type="text" id="publication" placeholder="CVPR, ICCV, etc." required>
            <div id="publication-error" class="error">Publication is required</div>
          </div>
          
          <div class="form-group">
            <label for="pub-year">Year:<span style="color: #e74c3c">*</span></label>
            <input type="text" id="pub-year" placeholder="2024" required pattern="[0-9]{4}">
            <div id="year-error" class="error">Valid year is required (format: YYYY)</div>
          </div>
          
          <div class="form-group">
            <label for="project-page">Project Page URL (optional):</label>
            <input type="url" id="project-page" placeholder="https://example.com/project">
            <div id="project-page-error" class="error">Please enter a valid URL</div>
          </div>
          
          <div class="form-group">
            <label for="paper-url">Paper URL (optional):</label>
            <input type="url" id="paper-url" placeholder="https://arxiv.org/abs/1234.56789">
            <div id="paper-url-error" class="error">Please enter a valid URL</div>
          </div>
          
          <div class="form-group">
            <label for="project-description">Project Description:<span style="color: #e74c3c">*</span></label>
            <textarea id="project-description" rows="5" placeholder="Enter project description" required></textarea>
            <div id="description-error" class="error">Description is required</div>
          </div>
          
          <div class="button-group">
            <button type="button" id="generate-btn">
              <span id="generate-spinner" class="spinner hidden"></span>
              <span id="generate-text">Generate HTML</span>
            </button>
            <button type="button" id="preview-btn" class="secondary">
              <i class="fas fa-eye"></i> Preview
            </button>
          </div>
        </form>
        
        <div id="output-container" class="output-container hidden">
          <h3>Generated HTML</h3>
          <p>Copy this code to your index.html file in the projects section.</p>
          <button id="copy-btn" class="copy-btn">
            <i class="fas fa-copy"></i> Copy
          </button>
          <code id="output-code"></code>
        </div>
        
        <div id="preview-container" class="preview hidden">
          <h3>Preview</h3>
          <div id="preview-content"></div>
        </div>
      </div>
      
      <div id="edit-project" class="tab-content">
        <h2>Edit Existing Project</h2>
        <p>This feature allows you to edit existing projects. Paste in the HTML of the project you want to edit:</p>
        
        <div class="form-group">
          <label for="existing-html">Paste existing project HTML:</label>
          <textarea id="existing-html" rows="10" placeholder="Paste the HTML of the project you want to edit" required></textarea>
          <div id="existing-html-error" class="error">Please paste valid HTML</div>
        </div>
        
        <button id="parse-existing">
          <span id="parse-spinner" class="spinner hidden"></span>
          <span id="parse-text">Parse HTML</span>
        </button>
        
        <div id="edit-form-container" class="hidden">
          <!-- Edit form will be added here after parsing -->
        </div>
      </div>
      
      <div id="help" class="tab-content">
        <h2>Help</h2>
        <h3>How to use this tool:</h3>
        <ol>
          <li><strong>Create a new project:</strong> Fill out the form with your project details and click "Generate HTML"</li>
          <li><strong>Preview:</strong> Click "Preview" to see how your project will look</li>
          <li><strong>Copy the HTML:</strong> Copy the generated HTML and paste it into your index.html file at the appropriate location (inside the project list section)</li>
          <li><strong>Edit a project:</strong> Paste the HTML of an existing project into the Edit tab and modify as needed</li>
        </ol>
        <h3>Important Notes:</h3>
        <ul>
          <li>Fields marked with <span style="color: #e74c3c">*</span> are required</li>
          <li>This tool doesn't automatically update your website files - you'll need to copy and paste the generated HTML</li>
          <li>Make sure to keep backup copies of your index.html before making significant changes</li>
          <li>Image paths should be relative to your website root (e.g., "images/myproject.jpg")</li>
          <li>For best results, maintain the same format for all projects</li>
        </ul>
        <h3>Tips for project images:</h3>
        <ul>
          <li>Use consistent image dimensions for all projects</li>
          <li>Recommended size: square images of at least 400x400 pixels</li>
          <li>If using video hover effects, ensure videos have the same dimensions as images</li>
          <li>Compress your images for faster loading times</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Set your password here (in a real application, you would use a server-side authentication)
    const CORRECT_PASSWORD = "8055";
    
    // Check if user is already logged in and fix any DOM reference issues
    document.addEventListener('DOMContentLoaded', function() {
      // Make sure elements exist before accessing them
      const loginSection = document.getElementById('login-section');
      const editorSection = document.getElementById('editor-section');
      
      if (!loginSection || !editorSection) {
        console.error('Critical elements missing from DOM');
        return;
      }
      
      if (localStorage.getItem('authenticated') === 'true') {
        loginSection.classList.add('hidden');
        editorSection.classList.remove('hidden');
      }
      
      // Tab functionality - ensure proper reference and event binding
      const tabs = document.querySelectorAll('.tab');
      if (tabs) {
        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            if (!tabId) return;
            
            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show active content - ensure elements exist
            const tabContents = document.querySelectorAll('.tab-content');
            if (tabContents) {
              tabContents.forEach(content => {
                content.classList.remove('active');
              });
              
              const activeTab = document.getElementById(tabId);
              if (activeTab) {
                activeTab.classList.add('active');
              }
            }
          });
        });
      }
    });
    
    // Login functionality - add error handling
    document.getElementById('login-btn').addEventListener('click', function() {
      const passwordInput = document.getElementById('password');
      const loginSection = document.getElementById('login-section');
      const editorSection = document.getElementById('editor-section');
      
      if (!passwordInput || !loginSection || !editorSection) {
        console.error('Missing login elements');
        alert('An error occurred. Please reload the page.');
        return;
      }
      
      const password = passwordInput.value;
      
      if (password === CORRECT_PASSWORD) {
        localStorage.setItem('authenticated', 'true');
        loginSection.classList.add('hidden');
        editorSection.classList.remove('hidden');
      } else {
        alert('Incorrect password. Please try again.');
      }
    });
    
    // Also allow Enter key for login
    document.getElementById('password').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const loginBtn = document.getElementById('login-btn');
        if (loginBtn) loginBtn.click();
      }
    });
    
    // Generate HTML for a new project - fix any reference errors
    document.getElementById('generate-btn').addEventListener('click', function() {
      const projectTitle = document.getElementById('project-title');
      const projectImage = document.getElementById('project-image');
      const projectVideo = document.getElementById('project-video');
      const authors = document.getElementById('authors');
      const publication = document.getElementById('publication');
      const pubYear = document.getElementById('pub-year');
      const projectPage = document.getElementById('project-page');
      const paperUrl = document.getElementById('paper-url');
      const projectDescription = document.getElementById('project-description');
      const outputCode = document.getElementById('output-code');
      const outputContainer = document.getElementById('output-container');
      const previewContainer = document.getElementById('preview-container');
      
      // Verify all required elements exist
      if (!projectTitle || !projectImage || !authors || !publication || 
          !pubYear || !projectDescription || !outputCode || 
          !outputContainer || !previewContainer) {
        console.error('Missing required form elements');
        alert('An error occurred. Please reload the page.');
        return;
      }
      
      // Validate required fields
      if (!projectTitle.value.trim()) {
        alert('Project title is required');
        projectTitle.focus();
        return;
      }
      if (!projectImage.value.trim()) {
        alert('Project image path is required');
        projectImage.focus();
        return;
      }
      if (!authors.value.trim()) {
        alert('At least one author is required');
        authors.focus();
        return;
      }
      if (!publication.value.trim()) {
        alert('Publication is required');
        publication.focus();
        return;
      }
      if (!pubYear.value.trim()) {
        alert('Year is required');
        pubYear.focus();
        return;
      }
      if (!projectDescription.value.trim()) {
        alert('Project description is required');
        projectDescription.focus();
        return;
      }
      
      const title = projectTitle.value.trim();
      const imagePath = projectImage.value.trim();
      const videoPath = projectVideo ? projectVideo.value.trim() : '';
      const authorsList = authors.value.split(',').map(author => author.trim());
      const publicationValue = publication.value.trim();
      const year = pubYear.value.trim();
      const projectPageUrl = projectPage ? projectPage.value.trim() : '';
      const paperUrlValue = paperUrl ? paperUrl.value.trim() : '';
      const description = projectDescription.value.trim();
      
      // Generate a unique ID for the project based on the title
      const projectId = title.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      
      // Generate HTML
      let html = `
    <tr onmouseout="${projectId}_stop()" onmouseover="${projectId}_start()">
      <td style="padding:16px;width:20%;vertical-align:middle">
        <div class="one">
          <div class="two" id='${projectId}_image'>`;
        
        if (videoPath) {
          html += `<video width=100% muted autoplay loop>
          <source src="${videoPath}" type="video/mp4">
          Your browser does not support the video tag.
          </video>`;
        }
        
        html += `</div>
          <img src='${imagePath}' width=100%>
        </div>
        <script type="text/javascript">
          function ${projectId}_start() {
            document.getElementById('${projectId}_image').style.opacity = "1";
          }

          function ${projectId}_stop() {
            document.getElementById('${projectId}_image').style.opacity = "0";
          }
          ${projectId}_stop()
        </script>
      </td>
      <td style="padding:8px;width:80%;vertical-align:middle">`;
        
        if (projectPageUrl) {
          html += `
        <a href="${projectPageUrl}">
          <span class="papertitle">${title}</span>
        </a>`;
        } else {
          html += `
        <span class="papertitle">${title}</span>`;
        }
        
        html += `
        <br>`;
        
        // Add authors
        for (let i = 0; i < authorsList.length; i++) {
          const author = authorsList[i].trim();
          
          if (author.toLowerCase().includes("jonathan") || author.toLowerCase().includes("barron")) {
            html += `
        <strong>${author}</strong>`;
          } else {
            html += `
        <a href="#">${author}</a>`;
          }
          
          if (i < authorsList.length - 1) {
            html += `,`;
          }
        }
        
        html += `
        <br>
        <em>${publicationValue}</em>, ${year}
        <br>`;
        
        // Add links
        if (projectPageUrl) {
          html += `
        <a href="${projectPageUrl}">project page</a>`;
          
          if (paperUrlValue) {
            html += `
        /`;
          }
        }
        
        if (paperUrlValue) {
          html += `
        <a href="${paperUrlValue}">arXiv</a>`;
        }
        
        html += `
        <p></p>
        <p>
        ${description}
        </p>
      </td>
    </tr>`;
      
      // Display output
      outputCode.textContent = html;
      outputContainer.classList.remove('hidden');
      previewContainer.classList.add('hidden');
    });
    
    // Preview functionality - ensure HTML is properly constructed
    document.getElementById('preview-btn').addEventListener('click', function() {
      const projectTitle = document.getElementById('project-title');
      const projectImage = document.getElementById('project-image');
      const projectDescription = document.getElementById('project-description');
      const previewContent = document.getElementById('preview-content');
      const previewContainer = document.getElementById('preview-container');
      const outputContainer = document.getElementById('output-container');
      
      if (!projectTitle || !projectImage || !projectDescription || 
          !previewContent || !previewContainer || !outputContainer) {
        console.error('Missing required preview elements');
        alert('An error occurred. Please reload the page.');
        return;
      }
      
      // Basic validation
      if (!projectTitle.value.trim() || !projectImage.value.trim() || !projectDescription.value.trim()) {
        alert('Please fill in all required fields (title, image, and description)');
        return;
      }
      
      const title = projectTitle.value.trim();
      const imagePath = projectImage.value.trim();
      const description = projectDescription.value.trim();
      
      // Create simplified preview HTML
      let previewHtml = `
        <table style="width:100%;border:0px;border-spacing:0px;border-collapse:separate;margin-right:auto;margin-left:auto;">
          <tbody>
            <tr>
              <td style="width:20%;vertical-align:middle">
                <img src="${imagePath}" width="100%" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg width=\'100\' height=\'100\' viewBox=\'0 0 100 100\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Crect width=\'100%25\' height=\'100%25\' fill=\'%23f8f9fa\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' font-size=\'14\' text-anchor=\'middle\' alignment-baseline=\'middle\' font-family=\'Arial, sans-serif\' fill=\'%23999\'%3EImage not found%3C/text%3E%3C/svg%3E';">
              </td>
              <td style="width:80%;vertical-align:middle;padding-left:15px;">
                <span style="font-weight:bold;font-size:16px;">${title}</span>
                <p>${description}</p>
              </td>
            </tr>
          </tbody>
        </table>
      `;
      
      previewContent.innerHTML = previewHtml;
      previewContainer.classList.remove('hidden');
      outputContainer.classList.add('hidden');
    });
    
    // Copy to clipboard - add error handling
    document.getElementById('copy-btn').addEventListener('click', function() {
      const outputCode = document.getElementById('output-code');
      
      if (!outputCode) {
        console.error('Output code element not found');
        alert('An error occurred. Please reload the page.');
        return;
      }
      
      const code = outputCode.textContent;
      
      // Fallback for browsers that don't support clipboard API
      if (!navigator.clipboard) {
        try {
          const textArea = document.createElement('textarea');
          textArea.value = code;
          textArea.style.position = 'fixed';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          if (successful) {
            alert('HTML copied to clipboard!');
          } else {
            throw new Error('Copy command failed');
          }
        } catch (err) {
          console.error('Fallback: Oops, unable to copy', err);
          alert('Failed to copy text. Please select and copy the text manually.');
        }
        return;
      }
      
      navigator.clipboard.writeText(code).then(() => {
        alert('HTML copied to clipboard!');
      }).catch(err => {
        console.error('Could not copy text: ', err);
        alert('Failed to copy text. Please select and copy the text manually.');
      });
    });
    
    // Fix for parse existing HTML functionality
    document.getElementById('parse-existing').addEventListener('click', function() {
      const existingHtml = document.getElementById('existing-html');
      const editFormContainer = document.getElementById('edit-form-container');
      
      if (!existingHtml || !editFormContainer) {
        console.error('Missing parse elements');
        alert('An error occurred. Please reload the page.');
        return;
      }
      
      if (!existingHtml.value.trim()) {
        alert('Please paste HTML to parse');
        existingHtml.focus();
        return;
      }
      
      try {
        // Create a temporary element to parse the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = existingHtml.value;
        
        // Check if this is valid project HTML
        const papertitleEl = tempDiv.querySelector('.papertitle');
        const imageEl = tempDiv.querySelector('img');
        
        if (!papertitleEl || !imageEl) {
          throw new Error('Invalid project HTML. Cannot find required elements.');
        }
        
        // Extract project details
        const projectTitle = papertitleEl.textContent.trim();
        const imagePath = imageEl.getAttribute('src');
        
        // Get video path if it exists
        let videoPath = '';
        const videoElement = tempDiv.querySelector('video source');
        if (videoElement) {
          videoPath = videoElement.getAttribute('src');
        }
        
        // Get authors
        const tdElement = tempDiv.querySelector('td[style*="80%"]');
        let authors = [];
        let currentNode = tdElement.querySelector('.papertitle').parentNode.nextSibling;
        
        // Skip to the first <br>
        while (currentNode && !(currentNode.nodeName === 'BR')) {
          currentNode = currentNode.nextSibling;
        }
        
        // Get the text between the first <br> and second <br>
        if (currentNode) {
          currentNode = currentNode.nextSibling; // Move past the <br>
          let authorText = '';
          
          while (currentNode && !(currentNode.nodeName === 'BR')) {
            if (currentNode.nodeType === Node.TEXT_NODE) {
              authorText += currentNode.textContent;
            } else if (currentNode.nodeType === Node.ELEMENT_NODE) {
              if (currentNode.nodeName === 'A' || currentNode.nodeName === 'STRONG') {
                authorText += currentNode.textContent;
              }
            }
            currentNode = currentNode.nextSibling;
          }
          
          authors = authorText.split(',').map(a => a.trim());
        }
        
        // Get publication and year
        let publication = '';
        let year = '';
        if (currentNode) {
          currentNode = currentNode.nextSibling; // Move past the second <br>
          let pubText = '';
          
          while (currentNode && !(currentNode.nodeName === 'BR')) {
            if (currentNode.nodeType === Node.TEXT_NODE) {
              pubText += currentNode.textContent;
            } else if (currentNode.nodeType === Node.ELEMENT_NODE && currentNode.nodeName === 'EM') {
              publication = currentNode.textContent;
            }
            currentNode = currentNode.nextSibling;
          }
          
          const pubMatch = pubText.match(/,\s*(\d{4})/);
          if (pubMatch) {
            year = pubMatch[1];
          }
        }
        
        // Get project page and paper URL
        let projectPage = '';
        let paperUrl = '';
        
        const links = tdElement.querySelectorAll('a');
        links.forEach(link => {
          const text = link.textContent.trim().toLowerCase();
          const href = link.getAttribute('href');
          
          if (text === 'project page') {
            projectPage = href;
          } else if (text === 'arxiv') {
            paperUrl = href;
          }
        });
        
        // Get description
        let description = '';
        const pElements = tdElement.querySelectorAll('p');
        if (pElements.length > 1) {
          description = pElements[pElements.length - 1].textContent.trim();
        }
        
        // Create the edit form
        const editFormHtml = `
          <h3>Edit Project</h3>
          <form id="edit-project-form">
            <div class="form-group">
              <label for="edit-project-title">Project Title:<span style="color: #e74c3c">*</span></label>
              <input type="text" id="edit-project-title" value="${projectTitle}" required>
              <div id="edit-title-error" class="error">Project title is required</div>
            </div>
            
            <div class="form-group">
              <label for="edit-project-image">Project Image Path:<span style="color: #e74c3c">*</span></label>
              <input type="text" id="edit-project-image" value="${imagePath}" required>
              <div id="edit-image-error" class="error">Image path is required</div>
            </div>
            
            <div class="form-group">
              <label for="edit-project-video">Project Video Path:</label>
              <input type="text" id="edit-project-video" value="${videoPath}">
            </div>
            
            <div class="form-group">
              <label for="edit-authors">Authors (comma separated):<span style="color: #e74c3c">*</span></label>
              <input type="text" id="edit-authors" value="${authors.join(', ')}" required>
              <div id="edit-authors-error" class="error">At least one author is required</div>
            </div>
            
            <div class="form-group">
              <label for="edit-publication">Publication:<span style="color: #e74c3c">*</span></label>
              <input type="text" id="edit-publication" value="${publication}" required>
              <div id="edit-publication-error" class="error">Publication is required</div>
            </div>
            
            <div class="form-group">
              <label for="edit-pub-year">Year:<span style="color: #e74c3c">*</span></label>
              <input type="text" id="edit-pub-year" value="${year}" required pattern="[0-9]{4}">
              <div id="edit-year-error" class="error">Valid year is required (format: YYYY)</div>
            </div>
            
            <div class="form-group">
              <label for="edit-project-page">Project Page URL:</label>
              <input type="url" id="edit-project-page" value="${projectPage}">
              <div id="edit-project-page-error" class="error">Please enter a valid URL</div>
            </div>
            
            <div class="form-group">
              <label for="edit-paper-url">Paper URL:</label>
              <input type="url" id="edit-paper-url" value="${paperUrl}">
              <div id="edit-paper-url-error" class="error">Please enter a valid URL</div>
            </div>
            
            <div class="form-group">
              <label for="edit-project-description">Project Description:<span style="color: #e74c3c">*</span></label>
              <textarea id="edit-project-description" rows="5" required>${description}</textarea>
              <div id="edit-description-error" class="error">Description is required</div>
            </div>
            
            <div class="button-group">
              <button type="button" id="update-btn">
                <span id="update-spinner" class="spinner hidden"></span>
                <span id="update-text">Update HTML</span>
              </button>
              <button type="button" id="edit-preview-btn" class="secondary">
                <i class="fas fa-eye"></i> Preview
              </button>
            </div>
          </form>
          
          <div id="edit-output-container" class="output-container hidden">
            <h3>Updated HTML</h3>
            <p>Copy this code to replace the original HTML in your index.html file.</p>
            <button id="edit-copy-btn" class="copy-btn">
              <i class="fas fa-copy"></i> Copy
            </button>
            <code id="edit-output-code"></code>
          </div>
          
          <div id="edit-preview-container" class="preview hidden">
            <h3>Preview</h3>
            <div id="edit-preview-content"></div>
          </div>
        `;
        
        document.getElementById('edit-form-container').innerHTML = editFormHtml;
        document.getElementById('edit-form-container').classList.remove('hidden');
        
        // Setup validation for edit form
        setupEditFormValidation();
        
        // Add event listeners for the edit form
        try {
          document.getElementById('update-btn').addEventListener('click', function updateHandler() {
            // Remove duplicate event handlers
            this.removeEventListener('click', updateHandler);
            
            if (!validateEditForm()) {
              showToast('Please fix the errors in the form', true);
              return;
            }
            
            const updateSpinner = document.getElementById('update-spinner');
            const updateText = document.getElementById('update-text');
            const updateBtn = document.getElementById('update-btn');
            
            // Show loading state
            updateSpinner.classList.remove('hidden');
            updateText.textContent = 'Updating...';
            updateBtn.disabled = true;
            
            setTimeout(() => {
              const title = document.getElementById('edit-project-title').value.trim();
              const imagePath = document.getElementById('edit-project-image').value.trim();
              const videoPath = document.getElementById('edit-project-video').value.trim();
              const authors = document.getElementById('edit-authors').value.split(',').map(author => author.trim());
              const publication = document.getElementById('edit-publication').value.trim();
              const year = document.getElementById('edit-pub-year').value.trim();
              const projectPage = document.getElementById('edit-project-page').value.trim();
              const paperUrl = document.getElementById('edit-paper-url').value.trim();
              const description = document.getElementById('edit-project-description').value.trim();
              
              // Generate a unique ID for the project based on the title
              const projectId = title.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
              
              // Generate HTML (same as the new project HTML generation)
              let html = `
    <tr onmouseout="${projectId}_stop()" onmouseover="${projectId}_start()">
      <td style="padding:16px;width:20%;vertical-align:middle">
        <div class="one">
          <div class="two" id='${projectId}_image'>`;
              
              if (videoPath) {
                html += `<video width=100% muted autoplay loop>
          <source src="${videoPath}" type="video/mp4">
          Your browser does not support the video tag.
          </video>`;
              }
              
              html += `</div>
          <img src='${imagePath}' width=100%>
        </div>
        <script type="text/javascript">
          function ${projectId}_start() {
            document.getElementById('${projectId}_image').style.opacity = "1";
          }

          function ${projectId}_stop() {
            document.getElementById('${projectId}_image').style.opacity = "0";
          }
          ${projectId}_stop()
        </script>
      </td>
      <td style="padding:8px;width:80%;vertical-align:middle">`;
              
              if (projectPage) {
                html += `
        <a href="${projectPage}">
          <span class="papertitle">${title}</span>
        </a>`;
              } else {
                html += `
        <span class="papertitle">${title}</span>`;
              }
              
              html += `
        <br>`;
              
              // Add authors
              for (let i = 0; i < authors.length; i++) {
                const author = authors[i].trim();
                
                if (author.toLowerCase().includes("jonathan") || author.toLowerCase().includes("barron")) {
                  html += `
        <strong>${author}</strong>`;
                } else {
                  html += `
        <a href="#">${author}</a>`;
                }
                
                if (i < authors.length - 1) {
                  html += `,`;
                }
              }
              
              html += `
        <br>
        <em>${publication}</em>, ${year}
        <br>`;
              
              // Add links
              if (projectPage) {
                html += `
        <a href="${projectPage}">project page</a>`;
                
                if (paperUrl) {
                  html += `
        /`;
                }
              }
              
              if (paperUrl) {
                html += `
        <a href="${paperUrl}">arXiv</a>`;
              }
              
              html += `
        <p></p>
        <p>
        ${description}
        </p>
      </td>
    </tr>`;
              
              // Display output
              document.getElementById('edit-output-code').textContent = html;
              document.getElementById('edit-output-container').classList.remove('hidden');
              document.getElementById('edit-preview-container').classList.add('hidden');
              
              // Reset button state
              updateSpinner.classList.add('hidden');
              updateText.textContent = 'Update HTML';
              updateBtn.disabled = false;
              
              // Scroll to the output
              document.getElementById('edit-output-container').scrollIntoView({ behavior: 'smooth' });
              
              showToast('HTML updated successfully');
            }, 800);
          });
        } catch (e) {
          console.error('Error setting up update button:', e);
        }
        
        try {
          document.getElementById('edit-preview-btn').addEventListener('click', function previewHandler() {
            // Remove duplicate event handlers
            this.removeEventListener('click', previewHandler);
            
            if (!validateEditForm()) {
              showToast('Please fix the errors in the form', true);
              return;
            }
            
            const title = document.getElementById('edit-project-title').value.trim();
            const imagePath = document.getElementById('edit-project-image').value.trim();
            const videoPath = document.getElementById('edit-project-video').value.trim();
            const description = document.getElementById('edit-project-description').value.trim();
            
            let previewHtml = `
              <table style="width:100%;border:0px;border-spacing:0px;border-collapse:separate;margin-right:auto;margin-left:auto;">
                <tbody>
                  <tr>
                    <td style="width:20%;vertical-align:middle">`;
                    
            if (videoPath) {
              previewHtml += `
                      <div style="position:relative;">
                        <video width="100%" autoplay loop muted style="display:block;">
                          <source src="${videoPath}" type="video/mp4">
                        </video>
                        <img src="${imagePath}" width="100%" style="position:absolute;top:0;left:0;opacity:0.3;">
                      </div>`;
            } else {
              previewHtml += `
                      <img src="${imagePath}" width="100%">`;
            }
            
            previewHtml += `
                    </td>
                    <td style="width:80%;vertical-align:middle;padding-left:20px;">
                      <span class="papertitle" style="font-weight:bold;font-size:18px;">${title}</span>
                      <p>${description}</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            `;
            
            document.getElementById('edit-preview-content').innerHTML = previewHtml;
            document.getElementById('edit-preview-container').classList.remove('hidden');
            document.getElementById('edit-output-container').classList.add('hidden');
            
            // Scroll to the preview
            document.getElementById('edit-preview-container').scrollIntoView({ behavior: 'smooth' });
          });
        } catch (e) {
          console.error('Error setting up edit preview button:', e);
        }
        
        try {
          document.getElementById('edit-copy-btn').addEventListener('click', function copyHandler() {
            // Remove duplicate event handlers
            this.removeEventListener('click', copyHandler);
            
            const code = document.getElementById('edit-output-code').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
              showToast('HTML copied to clipboard!');
              this.innerHTML = '<i class="fas fa-check"></i> Copied!';
              
              setTimeout(() => {
                this.innerHTML = '<i class="fas fa-copy"></i> Copy';
              }, 2000);
            }).catch(err => {
              showToast('Failed to copy: ' + err, true);
            });
          });
        } catch (e) {
          console.error('Error setting up edit copy button:', e);
        }
        
        // Scroll to the edit form
        document.getElementById('edit-form-container').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Error parsing HTML:', error);
        alert('Error parsing HTML: ' + error.message + '\nPlease check your input and try again.');
      }
    });
    
    // Setup validation for edit form
    function setupEditFormValidation() {
      const requiredFields = [
        { field: document.getElementById('edit-project-title'), error: document.getElementById('edit-title-error') },
        { field: document.getElementById('edit-project-image'), error: document.getElementById('edit-image-error') },
        { field: document.getElementById('edit-authors'), error: document.getElementById('edit-authors-error') },
        { field: document.getElementById('edit-publication'), error: document.getElementById('edit-publication-error') },
        { field: document.getElementById('edit-pub-year'), error: document.getElementById('edit-year-error') },
        { field: document.getElementById('edit-project-description'), error: document.getElementById('edit-description-error') }
      ];
      
      requiredFields.forEach(({ field, error }) => {
        if (field) {
          field.addEventListener('input', function() {
            if (field.validity.valid) {
              error.style.display = 'none';
            } else {
              error.style.display = 'block';
            }
          });
        }
      });
      
      // URL validation
      const editUrlFields = [
        document.getElementById('edit-project-page'),
        document.getElementById('edit-paper-url')
      ];
      
      editUrlFields.forEach(field => {
        if (field) {
          field.addEventListener('input', function() {
            const error = document.getElementById(`edit-${field.id.substring(5)}-error`);
            if (field.value === '' || field.validity.valid) {
              error.style.display = 'none';
            } else {
              error.style.display = 'block';
            }
          });
        }
      });
    }
    
    // Validate edit form
    function validateEditForm() {
      let isValid = true;
      
      // Check required fields
      const requiredFields = [
        { field: document.getElementById('edit-project-title'), error: document.getElementById('edit-title-error') },
        { field: document.getElementById('edit-project-image'), error: document.getElementById('edit-image-error') },
        { field: document.getElementById('edit-authors'), error: document.getElementById('edit-authors-error') },
        { field: document.getElementById('edit-publication'), error: document.getElementById('edit-publication-error') },
        { field: document.getElementById('edit-pub-year'), error: document.getElementById('edit-year-error') },
        { field: document.getElementById('edit-project-description'), error: document.getElementById('edit-description-error') }
      ];
      
      requiredFields.forEach(({ field, error }) => {
        if (field && !field.value.trim()) {
          error.style.display = 'block';
          isValid = false;
        } else if (field) {
          error.style.display = 'none';
        }
      });
      
      // Validate year format
      const editYear = document.getElementById('edit-pub-year');
      if (editYear && editYear.value && !/^\d{4}$/.test(editYear.value)) {
        document.getElementById('edit-year-error').style.display = 'block';
        isValid = false;
      }
      
      // Validate URLs (only if not empty)
      const editUrlFields = [
        document.getElementById('edit-project-page'),
        document.getElementById('edit-paper-url')
      ];
      
      editUrlFields.forEach(field => {
        if (field) {
          const error = document.getElementById(`edit-${field.id.substring(5)}-error`);
          if (field.value && !field.validity.valid) {
            error.style.display = 'block';
            isValid = false;
          } else {
            error.style.display = 'none';
          }
        }
      });
      
      return isValid;
    }
  </script>
</body>
</html>
